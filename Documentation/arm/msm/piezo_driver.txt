Introduction
============
A software implementation is required to provide a range of clock signals
to an external piezoelectric sound buzzer. There is a clock feature embedded
in MSM which can be utilized for providing different range of clock. MSM chipset
has M/N:D counter where M, N and D values are programmed into the specified
registers. The M/N:D counter is a type of  PLL (Phased Loop Lock) circuit
and implements a technique to provide a range of different frequencies
by counting clocks with one clock source provided. As implied by the name,
M is a multiplier and N is a divider of source clock. D is duty cycle ratio
between high and low value of a clock pulse.

As the result of writing to the registers, the frequency calculated
by the M, N and D values are generated to the specified GPIO pin.
This is called as GP_MN which is different from GP_CLK in that it has only
one clock source(TCXO/4 at 4.8 MHz). The clock generated by M/N:D counter
is used as an input source for piezoelectric sounder.

In order to determine the value of M, N and D, the driver interacts with user
space via Sysfs. The interface to the user space is frequency, duration,
duty cycle and command (enable). When command is written to interface,
the driver calculates the values and update registers to turn the clock
on and off.


Hardware Description
====================
Piezoelectric sounder is mounted externally and GP_MN GPIO pin is connected
to the sounder.


Software Description
====================
The driver is responsible for
- MSM GP_PDM(General Purpose Pulse Density Modulation) and clock configuration
- Configuration of the M, N, D values for the M/N:D counter by writing to
  GP_MN_CLK_MDIV,GP_MN_CLK_NDIV and GP_MN_CLK_DUTY.
- Interaction with user space to determine target frequency, duration and duty
  cycle.


Design
======
Piezo kernel driver is a different model to the traditional kernel driver
such as character, block or network driver. It utilizes the embedded feature
to generate the clock. When the target frequency, duty cycle and duration
are provided, the driver will simply turn on the clock(GP_MN)
for that duration.

Based on the nature of the driver required, Piezo driver registers as static
module if CONFIG_PIEZO_CLK_MND is defined in target definition file,
defconfig and implemented as a platform driver.

-Initialization
During the initialization, the driver is registered as a platform driver. Piezo
Sysfs entry and workqueue structures are initialized.

Piezo driver also supports the device tree binding. Driver name and PDM
register address will be specified in the device tree. There are also
optional parameters which can be the default value of target frequency,
duration and duty cycle.

- Use of work-queue
The kernel driver is implemented to turn on the clock and provide the target
frequency for the duration provided. And once the time reaches, it notifies
the user space through /sys/kernel/piezo/command interface. Therefore, if the
user space application monitors this file, it knows when to send the next
request.

In order to use timer instead of work-queue, it requires the
operations in timer callback to be atomic operation. When the timer expires,
it is needed to let the user space application know whether the piezo task
has been completed and the way we do is via sys_notify(). As this function is
not running in atomic context rather it runs in process context.
Therefore, work-queue is being used to perform the task for the specified time.

- Use of Sysfs
In order to get the inputs (frequency, duration and duty cycle) from the user
space, it is decided to use Sysfs which is one of the embedded features in
recent kernel releases.
Refer to Sysfs Interface section for further details.


Sysfs Interface (Userspace)
===========================
/sys/kernel/piezo/ directory is created under kernel k-object.
The following files are generated to get the value of target frequency, duration
and duty cycle.

- frequency    The frequency provided to piezo buzzer.
               Supported values are 1K to 6K.
- duration     The duration that the client wants to run the piezo buzzer.
               Unit is in ms
- duty_cycle   The percentage of one period when a signal is active.
               1 to 100. Recommended values are 25, 50 and 75.
- command      The command interface to start the clock on and off.
               1 - On command, 0 - Off command

